<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Inventory System</title>
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>

    <nav>
        <div class="logo-container">
            <img src="../static/cropwise_logo.png" alt="Logo" class="logo">
            <h1>CropWise</h1>
        </div>
        <ul>
            <li class="account-dropdown">
                <a href="#account">My Account | admin</a>
                <div class="dropdown-content">
                    <a href="#profile">Profile</a>
                    <a href="#settings">Settings</a>
                    <a href="/">Logout</a>
                </div>
            </li>
        </ul>
    </nav>
    
    <div class="main-nav">
        <ul>
            <li><a href="/home">Home</a></li>
            <li><a href="/loginsuccessful">Crop Inventory</a></li>
            <li><a href="#Harvest-Management">Harvest Management</a></li>
        </ul>
    </div>

    <div class="container">
        <button id="toggle-add-crop-form">+ New Crop</button>

        <form id="add-crop-form" style="display:none;">
            <h2 id="form-title">Add Crop</h2>
            <input type="text" id="localName" placeholder="Local Name" required>
            <select id="category" required>
                <option value="" disabled selected>Select Category</option>
                <option value="Vegetables">Vegetables</option>
                <option value="Fruits">Fruits</option>
                <option value="Fibre Crop">Fibre Crop</option>
                <option value="Nut">Nut</option>
                <option value="Root and Tuber">Root and Tuber</option>
                <option value="Grain">Grain</option>
                <option value="Tobacco">Tobacco</option>
                <option value="Pulse">Pulse</option>
                <option value="Oil Crop">Oil Crop</option>
            </select>
            <select id="seasonality" required>
                <option value="" disabled selected>Select Seasonality</option>
                <option value="Wet">Wet</option>
                <option value="Dry">Dry</option>
                <option value="Wet and Dry">Wet and Dry</option>
            </select>
            <select id="flagDescription" required>
                <option value="" disabled selected>Select Flag Description</option>
                <option value="Organic">Organic</option>
                <option value="Non-GMO">Non-GMO</option>
                <option value="Hybrid">Hybrid</option>
                <option value="Heirloom">Heirloom</option>
            </select>
            <input type="date" id="harvestDate" required>
            <input type="number" id="quantity" placeholder="Quantity" required>
            <button type="button" id="add-crop-button" onclick="addCrop()">Add Crop</button>
            <button type="button" id="update-crop-button" onclick="updateCrop()" style="display:none;">Update Crop</button>
        </form>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search for crops..." onkeyup="search()">
        </div>

        <div id="crop-table">
            <h2>Crop List</h2>
            <div id="sort-options" class="sort-by-dropdown">
                <h4>Sort By:</h4>
                <select id="sortBy" onchange="sortCrops()">
                    <option value="itemCode">Item Code</option>
                    <option value="localName">Local Name</option>
                    <option value="category">Category</option>
                    <option value="seasonality">Seasonality</option>
                    <option value="flagDescription">Flag Description</option>
                    <option value="harvestDate">Harvest Date</option>
                    <option value="quantity">Quantity</option>
                </select>
                <h4>Sort Order:</h4>
                <select id="sortOrder" onchange="sortCrops()">
                    <option value="ascending">Ascending</option>
                    <option value="descending">Descending</option>
                </select>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Local Name</th>
                        <th>Category</th>
                        <th>Seasonality</th>
                        <th>Flag Description</th>
                        <th>Harvest Date</th>
                        <th>Quantity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="crop-list">
                    <!-- Crop entries will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let crops = [];  // Keep track of crops data locally
        let editIndex = null;

        // Fetch and display crops when page loads or after adding a crop
        function fetchAndDisplayCrops() {
            fetch('/get_crops')
                .then(response => response.json())
                .then(data => {
                    crops = data;  // Update the crops array with the new data
                    displayCrops(crops);  // Display the crops in the table
                })
                .catch(error => console.error('Error fetching crops:', error));
        }

        // Add crop (this will now create a new crop)
        function addCrop() {
            const localName = document.getElementById('localName').value;
            const category = document.getElementById('category').value;
            const seasonality = document.getElementById('seasonality').value;
            const flagDescription = document.getElementById('flagDescription').value;
            const harvestDate = document.getElementById('harvestDate').value;
            const quantity = document.getElementById('quantity').value;

            const crop = {
                localName,
                category,
                seasonality,
                flagDescription,
                harvestDate,
                quantity
            };

            fetch('/add_crop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(crop)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchAndDisplayCrops();  // Refresh the crop list after adding
                    document.getElementById('add-crop-form').reset();
                    document.getElementById('add-crop-form').style.display = 'none';
                } else {
                    alert('Failed to add crop.');
                }
            })
            .catch(error => console.error('Error adding crop:', error));
        }

        // Update existing crop
        function updateCrop() {
            const localName = document.getElementById('localName').value;
            const category = document.getElementById('category').value;
            const seasonality = document.getElementById('seasonality').value;
            const flagDescription = document.getElementById('flagDescription').value;
            const harvestDate = document.getElementById('harvestDate').value;
            const quantity = document.getElementById('quantity').value;

            const crop = {
                id: crops[editIndex].id,  // Include the crop ID for updating
                localName,
                category,
                seasonality,
                flagDescription,
                harvestDate,
                quantity
            };

            fetch('/update_crop', {
                method: 'PUT', // Use PUT method
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(crop)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchAndDisplayCrops();  // Refresh the crop list after updating
                    document.getElementById('add-crop-form').reset();  // Clear the form
                    document.getElementById('add-crop-form').style.display = 'none';  // Hide the form
                    document.getElementById('add-crop-button').style.display = 'block';  // Show Add Crop button
                    document.getElementById('update-crop-button').style.display = 'none';  // Hide Update button
                } else {
                    alert('Failed to update crop.');
                }
            })
            .catch(error => console.error('Error updating crop:', error));
        }

        // Edit crop function (sets the form for editing)
        function editCrop(index) {
            const crop = crops[index];
            document.getElementById('localName').value = crop.localName;
            document.getElementById('category').value = crop.category;
            document.getElementById('seasonality').value = crop.seasonality;
            document.getElementById('flagDescription').value = crop.flagDescription;
            document.getElementById('harvestDate').value = crop.harvestDate;
            document.getElementById('quantity').value = crop.quantity;

            editIndex = index;  // Set the index of the crop being edited
            document.getElementById('add-crop-button').style.display = 'none';
            document.getElementById('update-crop-button').style.display = 'block';
            document.getElementById('add-crop-form').style.display = 'block';
        }

        // Sort crops
        function sortCrops() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            fetch('/sort_crops', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sortBy, sortOrder })
            })
            .then(response => response.json())
            .then(data => {
                displayCrops(data);
            })
            .catch(error => console.error('Error sorting crops:', error));
        }

        // Display crops in the table
        function displayCrops(crops) {
            const cropList = document.getElementById("crop-list");
            cropList.innerHTML = "";

            crops.forEach((crop, index) => {
                const cropRow = document.createElement("tr");
                cropRow.innerHTML = `
                    <td>${crop.itemCode}</td>
                    <td>${crop.localName}</td>
                    <td>${crop.category}</td>
                    <td>${crop.seasonality}</td>
                    <td>${crop.flagDescription}</td>
                    <td>${crop.harvestDate}</td>
                    <td>${crop.quantity}</td>
                    <td>
                        <button onclick="editCrop(${index})">Edit</button>
                        <button onclick="deleteCrop(${index})">Delete</button>
                    </td>
                `;
                cropList.appendChild(cropRow);
            });
        }

        // Delete crop function
        function deleteCrop(index) {
            const crop = crops[index];

            // Make a DELETE request to the server to delete the crop
            fetch(`/delete_crop/${crop.itemCode}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    crops.splice(index, 1);  // Remove from local array
                    displayCrops(crops);      // Refresh the display
                } else {
                    alert('Failed to delete crop.');
                }
            })
            .catch(error => console.error('Error deleting crop:', error));
        }

        // Search function
        function search() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredCrops = crops.filter(crop => {
                return crop.localName.toLowerCase().includes(searchTerm) ||
                    crop.category.toLowerCase().includes(searchTerm) ||
                    crop.seasonality.toLowerCase().includes(searchTerm) ||
                    crop.itemCode.toString().includes(searchTerm) ||
                    crop.flagDescription.toLowerCase().includes(searchTerm) ||
                    crop.harvestDate.toLowerCase().includes(searchTerm) ||
                    crop.quantity.toString().includes(searchTerm);
            });
            displayCrops(filteredCrops);
        }

        // Initialize the page by fetching crops
        document.addEventListener("DOMContentLoaded", function() {
            fetchAndDisplayCrops();
            
            document.getElementById('toggle-add-crop-form').addEventListener('click', function() {
                const form = document.getElementById('add-crop-form');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
